# Ralph Progress Log
Started: Sun Jan 11 22:25:27 CST 2026
---

## Codebase Patterns
- Validation logic lives in `src/lib/{domain}/validation.ts` with matching `.test.ts` files
- Use Zod schemas for form validation, helper functions for async/business logic
- Mock Supabase client in tests using `vi.mock("@/lib/supabase/client")` and `vi.mocked(createClient)`
- Tests use describe/it pattern with safeParse for schema tests, async/await for function tests
- Form components use react-hook-form with zodResolver
- Use `ilike()` for case-insensitive Supabase queries
- Toast notifications: import `{ toast } from "sonner"` - use `toast.success()` and `toast.error()`
- Vitest setup file at `vitest.setup.ts` imports `@testing-library/jest-dom/vitest` for matchers
- For component tests with user interactions, install `@testing-library/user-event` and use `userEvent.setup()`
- When mocking Supabase delete with chained `.eq()`, mock returns objects with nested `.eq()` methods
- Use `vi.hoisted()` for mock variables used in `vi.mock()` factory functions to avoid hoisting issues
- When testing Radix Dialog, find dialog buttons by `data-variant` attribute rather than index
---

## 2026-01-12 04:29 CST - US-V4-001
- What was implemented:
  - Added `validateSeasonName()` function to check for duplicate season names (case-insensitive)
  - Integrated validation into season creation form with onBlur and onSubmit checks
  - Added inline error display and loading state while validating
  - Submit button disabled when name is invalid or validation in progress
- Files changed:
  - src/lib/seasons/validation.ts (added validateSeasonName function and types)
  - src/lib/seasons/validation.test.ts (added 7 tests for validateSeasonName)
  - src/app/dashboard/seasons/new/page.tsx (added validation UI and handlers)
- **Learnings for future iterations:**
  - Supabase `ilike()` filter does case-insensitive matching but doesn't do exact match, so follow up with JS comparison
  - When mocking Supabase client, use chained mocks: `from().select().eq().ilike()`
  - Form validation on blur requires both calling field.onBlur() and custom handler
---

## 2026-01-12 04:36 CST - US-V4-002
- What was implemented:
  - Added `validatePlayerNameForDuplicate()` function for case-insensitive duplicate player name checking
  - Added `normalizePlayerName()` helper to trim whitespace and collapse multiple spaces
  - Integrated validation into RosterManager component with onBlur and onSubmit checks
  - Added inline warning message with option to add existing player to season instead
  - Submit button disabled when name is invalid or validation in progress
- Files changed:
  - src/lib/players/validation.ts (added validatePlayerNameForDuplicate, normalizePlayerName, and types)
  - src/lib/players/validation.test.ts (added 14 tests for duplicate detection and normalization)
  - src/app/dashboard/seasons/[id]/roster-manager.tsx (added validation UI and handlers)
- **Learnings for future iterations:**
  - Player validation pattern mirrors season validation but adds `normalizePlayerName()` for space collapsing
  - When showing duplicate warning, provide option to add existing player to roster as alternative action
  - Use regex `/\s+/g` to collapse multiple spaces to single space
---

## 2026-01-12 04:41 CST - US-V4-016
- What was implemented:
  - Added Toaster component to root layout (src/app/layout.tsx) with position: bottom-right, duration: 4000ms
  - Added toast.success() for season creation in new season page
  - Added toast.success() for player added to roster (both new and existing players)
  - Added toast.error() for failed saves and API errors
  - Created vitest.setup.ts with @testing-library/jest-dom/vitest for test matchers
  - Created layout.test.tsx with 4 tests for Toaster configuration
- Files changed:
  - src/app/layout.tsx (added Toaster import and component)
  - src/app/layout.test.tsx (new - 4 tests for Toaster)
  - src/app/dashboard/seasons/new/page.tsx (added toast calls for success/error)
  - src/app/dashboard/seasons/[id]/roster-manager.tsx (added toast calls for player add/error)
  - vitest.config.ts (added setupFiles)
  - vitest.setup.ts (new - jest-dom matchers setup)
  - package.json (added @testing-library/jest-dom)
- **Learnings for future iterations:**
  - Sonner Toaster is a client component that can be added to server layout components
  - Mock sonner's Toaster in component tests to inspect props via data attributes
  - Root layout tests will show HTML nesting warnings (expected, not an error)
---

## 2026-01-12 04:47 CST - US-V4-003
- What was implemented:
  - Added confirmation dialog for player removal using existing Dialog component
  - Dialog shows "Remove [Player Name] from this season's roster?"
  - Cancel button closes dialog without action
  - Remove button executes removal with toast.success('[Player Name] removed from roster')
  - Added toast.error() for failed removal API calls
  - Created comprehensive test file for roster-manager component
- Files changed:
  - src/app/dashboard/seasons/[id]/roster-manager.tsx (added dialog state, handlers, and Dialog component)
  - src/app/dashboard/seasons/[id]/roster-manager.test.tsx (new - 7 tests for confirmation dialog)
  - package.json (added @testing-library/user-event)
- **Learnings for future iterations:**
  - Use `vi.hoisted()` for mock variables referenced in `vi.mock()` factory functions
  - Radix Dialog portal renders outside main DOM tree; use `findByRole("dialog")` then query within
  - Find buttons in dialog by `data-variant` attribute (e.g., `data-variant="destructive"`)
  - Chain Supabase mocks properly: `.delete().eq().eq()` needs nested mock objects
---

## 2026-01-12 04:50 CST - US-V4-004
- What was implemented:
  - Added visible warning message (yellow Alert) above Generate Schedule button when player count is invalid
  - Button was already disabled via validation logic, tooltip already showing disabled reason
  - Created comprehensive test file with 9 tests covering disabled states, warning visibility, and boundary conditions
- Files changed:
  - src/app/dashboard/seasons/[id]/weeks/[weekId]/schedule-generator.tsx (added warning Alert)
  - src/app/dashboard/seasons/[id]/weeks/[weekId]/schedule-generator.test.tsx (new - 9 tests)
- **Learnings for future iterations:**
  - Schedule generation component already had good validation infrastructure via `validateAvailableCount()`
  - MIN_AVAILABLE_PLAYERS (24) and MAX_AVAILABLE_PLAYERS (32) constants from `src/lib/availability/validation.ts`
  - Component tests for this component don't need complex Supabase mocking since generation is client-side
---

## 2026-01-12 04:54 CST - US-V4-005
- What was implemented:
  - Simplified `findActiveWeekId()` function to return the earliest non-completed week (by week_number)
  - Previously the function was overly complex, tracking "closest to today" logic that wasn't needed
  - Created comprehensive test file with 12 tests covering tab styling, navigation, active week label, and findActiveWeekId logic
- Files changed:
  - src/app/dashboard/seasons/[id]/week-utils.ts (simplified findActiveWeekId function)
  - src/app/dashboard/seasons/[id]/week-navigation.test.tsx (new - 12 tests)
- **Learnings for future iterations:**
  - Radix Tabs uses `data-state="active"` attribute for selected tab styling
  - WeekNavigation renders both mobile and desktop views, so tests should use `getAllByText` when searching for week numbers
  - `findActiveWeekId` sorts by week_number to handle unsorted input arrays correctly
---
