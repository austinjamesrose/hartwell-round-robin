# Ralph Progress Log
Started: Sun Jan 11 22:25:27 CST 2026
---

## Codebase Patterns
- Validation logic lives in `src/lib/{domain}/validation.ts` with matching `.test.ts` files
- Use Zod schemas for form validation, helper functions for async/business logic
- Mock Supabase client in tests using `vi.mock("@/lib/supabase/client")` and `vi.mocked(createClient)`
- Tests use describe/it pattern with safeParse for schema tests, async/await for function tests
- Form components use react-hook-form with zodResolver
- Use `ilike()` for case-insensitive Supabase queries
- Toast notifications: import `{ toast } from "sonner"` - use `toast.success()` and `toast.error()`
- Vitest setup file at `vitest.setup.ts` imports `@testing-library/jest-dom/vitest` for matchers
- For component tests with user interactions, install `@testing-library/user-event` and use `userEvent.setup()`
- When mocking Supabase delete with chained `.eq()`, mock returns objects with nested `.eq()` methods
- Use `vi.hoisted()` for mock variables used in `vi.mock()` factory functions to avoid hoisting issues
- When testing Radix Dialog, find dialog buttons by `data-variant` attribute rather than index
- **Date handling**: Use `formatDate()` and `calculateWeekDates()` from `@/lib/dates/dateUtils` for timezone-safe date operations
---

## 2026-01-12 04:29 CST - US-V4-001
- What was implemented:
  - Added `validateSeasonName()` function to check for duplicate season names (case-insensitive)
  - Integrated validation into season creation form with onBlur and onSubmit checks
  - Added inline error display and loading state while validating
  - Submit button disabled when name is invalid or validation in progress
- Files changed:
  - src/lib/seasons/validation.ts (added validateSeasonName function and types)
  - src/lib/seasons/validation.test.ts (added 7 tests for validateSeasonName)
  - src/app/dashboard/seasons/new/page.tsx (added validation UI and handlers)
- **Learnings for future iterations:**
  - Supabase `ilike()` filter does case-insensitive matching but doesn't do exact match, so follow up with JS comparison
  - When mocking Supabase client, use chained mocks: `from().select().eq().ilike()`
  - Form validation on blur requires both calling field.onBlur() and custom handler
---

## 2026-01-12 04:36 CST - US-V4-002
- What was implemented:
  - Added `validatePlayerNameForDuplicate()` function for case-insensitive duplicate player name checking
  - Added `normalizePlayerName()` helper to trim whitespace and collapse multiple spaces
  - Integrated validation into RosterManager component with onBlur and onSubmit checks
  - Added inline warning message with option to add existing player to season instead
  - Submit button disabled when name is invalid or validation in progress
- Files changed:
  - src/lib/players/validation.ts (added validatePlayerNameForDuplicate, normalizePlayerName, and types)
  - src/lib/players/validation.test.ts (added 14 tests for duplicate detection and normalization)
  - src/app/dashboard/seasons/[id]/roster-manager.tsx (added validation UI and handlers)
- **Learnings for future iterations:**
  - Player validation pattern mirrors season validation but adds `normalizePlayerName()` for space collapsing
  - When showing duplicate warning, provide option to add existing player to roster as alternative action
  - Use regex `/\s+/g` to collapse multiple spaces to single space
---

## 2026-01-12 04:41 CST - US-V4-016
- What was implemented:
  - Added Toaster component to root layout (src/app/layout.tsx) with position: bottom-right, duration: 4000ms
  - Added toast.success() for season creation in new season page
  - Added toast.success() for player added to roster (both new and existing players)
  - Added toast.error() for failed saves and API errors
  - Created vitest.setup.ts with @testing-library/jest-dom/vitest for test matchers
  - Created layout.test.tsx with 4 tests for Toaster configuration
- Files changed:
  - src/app/layout.tsx (added Toaster import and component)
  - src/app/layout.test.tsx (new - 4 tests for Toaster)
  - src/app/dashboard/seasons/new/page.tsx (added toast calls for success/error)
  - src/app/dashboard/seasons/[id]/roster-manager.tsx (added toast calls for player add/error)
  - vitest.config.ts (added setupFiles)
  - vitest.setup.ts (new - jest-dom matchers setup)
  - package.json (added @testing-library/jest-dom)
- **Learnings for future iterations:**
  - Sonner Toaster is a client component that can be added to server layout components
  - Mock sonner's Toaster in component tests to inspect props via data attributes
  - Root layout tests will show HTML nesting warnings (expected, not an error)
---

## 2026-01-12 04:47 CST - US-V4-003
- What was implemented:
  - Added confirmation dialog for player removal using existing Dialog component
  - Dialog shows "Remove [Player Name] from this season's roster?"
  - Cancel button closes dialog without action
  - Remove button executes removal with toast.success('[Player Name] removed from roster')
  - Added toast.error() for failed removal API calls
  - Created comprehensive test file for roster-manager component
- Files changed:
  - src/app/dashboard/seasons/[id]/roster-manager.tsx (added dialog state, handlers, and Dialog component)
  - src/app/dashboard/seasons/[id]/roster-manager.test.tsx (new - 7 tests for confirmation dialog)
  - package.json (added @testing-library/user-event)
- **Learnings for future iterations:**
  - Use `vi.hoisted()` for mock variables referenced in `vi.mock()` factory functions
  - Radix Dialog portal renders outside main DOM tree; use `findByRole("dialog")` then query within
  - Find buttons in dialog by `data-variant` attribute (e.g., `data-variant="destructive"`)
  - Chain Supabase mocks properly: `.delete().eq().eq()` needs nested mock objects
---

## 2026-01-12 04:50 CST - US-V4-004
- What was implemented:
  - Added visible warning message (yellow Alert) above Generate Schedule button when player count is invalid
  - Button was already disabled via validation logic, tooltip already showing disabled reason
  - Created comprehensive test file with 9 tests covering disabled states, warning visibility, and boundary conditions
- Files changed:
  - src/app/dashboard/seasons/[id]/weeks/[weekId]/schedule-generator.tsx (added warning Alert)
  - src/app/dashboard/seasons/[id]/weeks/[weekId]/schedule-generator.test.tsx (new - 9 tests)
- **Learnings for future iterations:**
  - Schedule generation component already had good validation infrastructure via `validateAvailableCount()`
  - MIN_AVAILABLE_PLAYERS (24) and MAX_AVAILABLE_PLAYERS (32) constants from `src/lib/availability/validation.ts`
  - Component tests for this component don't need complex Supabase mocking since generation is client-side
---

## 2026-01-12 04:54 CST - US-V4-005
- What was implemented:
  - Simplified `findActiveWeekId()` function to return the earliest non-completed week (by week_number)
  - Previously the function was overly complex, tracking "closest to today" logic that wasn't needed
  - Created comprehensive test file with 12 tests covering tab styling, navigation, active week label, and findActiveWeekId logic
- Files changed:
  - src/app/dashboard/seasons/[id]/week-utils.ts (simplified findActiveWeekId function)
  - src/app/dashboard/seasons/[id]/week-navigation.test.tsx (new - 12 tests)
- **Learnings for future iterations:**
  - Radix Tabs uses `data-state="active"` attribute for selected tab styling
  - WeekNavigation renders both mobile and desktop views, so tests should use `getAllByText` when searching for week numbers
  - `findActiveWeekId` sorts by week_number to handle unsorted input arrays correctly
---

## 2026-01-12 04:59 CST - US-V4-006
- What was implemented:
  - Created `src/lib/dates/dateUtils.ts` with timezone-safe date utility functions
  - Added `formatDate()` - displays YYYY-MM-DD dates without timezone conversion (no off-by-one bugs)
  - Added `parseDateString()` - extracts year/month/day components from date string
  - Added `parseFormDate()` - validates and normalizes form date inputs
  - Added `calculateWeekDates()` - calculates week dates without timezone bugs (replaces old version)
  - Added `addDays()` - adds/subtracts days from date strings safely
  - Updated all formatDate usage across dashboard, season, week, and player pages
  - Updated week-navigation.tsx to use timezone-safe formatDateCompact and formatDateFull
  - Re-exported calculateWeekDates from validation.ts to maintain backwards compatibility
  - Fixed existing test that had wrong expected value due to old timezone bug
- Files changed:
  - src/lib/dates/dateUtils.ts (new - date utility functions)
  - src/lib/dates/dateUtils.test.ts (new - 33 comprehensive tests)
  - src/lib/seasons/validation.ts (re-export calculateWeekDates from dateUtils)
  - src/lib/seasons/validation.test.ts (fixed date expectation from "2026-03-18" to "2026-03-19")
  - src/app/dashboard/page.tsx (import formatDate from dateUtils)
  - src/app/dashboard/seasons/[id]/page.tsx (import formatDate from dateUtils)
  - src/app/dashboard/seasons/[id]/week-navigation.tsx (use timezone-safe date formatting)
  - src/app/dashboard/seasons/[id]/weeks/[weekId]/page.tsx (import formatDate from dateUtils)
  - src/app/dashboard/seasons/[id]/players/[playerId]/page.tsx (import formatDate from dateUtils)
- **Learnings for future iterations:**
  - `new Date("YYYY-MM-DD")` interprets as UTC midnight, causing off-by-one in timezones behind UTC
  - To display dates timezone-safely, parse components directly from string and format manually
  - `new Date(year, month-1, day)` creates a local date without timezone conversion
  - When fixing timezone bugs, existing tests may have wrong expected values that were "correct" for the buggy code
---

## 2026-01-12 05:06 CST - US-V4-007
- What was implemented:
  - Created `/dashboard/seasons/[id]/roster/page.tsx` - server component for roster management
  - Created `/dashboard/seasons/[id]/schedule/page.tsx` - server component with week listing and navigation
  - Created `/dashboard/seasons/[id]/leaderboard/page.tsx` - server component for player rankings
  - Updated `[id]/page.tsx` to redirect to `/schedule` by default (simplified to just redirect)
  - Each page fetches its own data independently (server component pattern)
  - Extracted existing RosterManager and Leaderboard components used as-is in new pages
- Files changed:
  - src/app/dashboard/seasons/[id]/roster/page.tsx (new - roster management page)
  - src/app/dashboard/seasons/[id]/schedule/page.tsx (new - week schedule listing)
  - src/app/dashboard/seasons/[id]/leaderboard/page.tsx (new - player rankings)
  - src/app/dashboard/seasons/[id]/page.tsx (simplified to redirect only)
- **Learnings for future iterations:**
  - Next.js dynamic routes with `[id]` need proper quoting in shell commands due to bracket characters
  - Server components can import client components (e.g., RosterManager) but not vice versa
  - Each route page can do its own data fetching - good for code splitting and isolation
  - redirect() from next/navigation doesn't return, so no need for further code after it
---

## 2026-01-12 05:09 CST - US-V4-008
- What was implemented:
  - Created SeasonNav component in src/app/dashboard/seasons/[id]/components/
  - Links to: Roster (/roster), Schedule (/schedule), Leaderboard (/leaderboard)
  - On mobile (< 768px): Fixed bottom navigation bar with icons
  - On desktop (>= 768px): Horizontal tabs below season header
  - Uses lucide-react icons: Users (roster), Calendar (schedule), Trophy (leaderboard)
  - Current section indicated via data-active attribute and active styling (blue border/text)
  - Touch targets minimum 44px on mobile (min-h-[44px] min-w-[44px])
  - Navigation is sticky (fixed bottom on mobile)
  - Added SeasonNav to roster/page.tsx, schedule/page.tsx, leaderboard/page.tsx
- Files changed:
  - src/app/dashboard/seasons/[id]/components/SeasonNav.tsx (new - responsive nav component)
  - src/app/dashboard/seasons/[id]/components/SeasonNav.test.tsx (new - 14 comprehensive tests)
  - src/app/dashboard/seasons/[id]/roster/page.tsx (added SeasonNav import and component)
  - src/app/dashboard/seasons/[id]/schedule/page.tsx (added SeasonNav import and component)
  - src/app/dashboard/seasons/[id]/leaderboard/page.tsx (added SeasonNav import and component)
- **Learnings for future iterations:**
  - Use usePathname() from next/navigation to determine current route for active state
  - Mock next/navigation in tests with vi.mock() and vi.mocked(usePathname)
  - Use data-testid for responsive elements to verify presence in DOM
  - Tailwind responsive classes: md:hidden (show on mobile only), hidden md:block (show on desktop only)
  - For client components imported into server components, mark with "use client" directive
---
